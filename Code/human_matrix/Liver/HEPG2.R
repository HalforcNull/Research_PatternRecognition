# R script to download selected samples
# Copy code and run on a local machine to initiate download

# Check for dependencies and install if missing
packages <- c("rhdf5")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
    print("Install required packages")
    source("https://bioconductor.org/biocLite.R")
    biocLite("rhdf5")
}
library("rhdf5")
library("tools")

destination_file = "human_matrix_download.h5"
extracted_expression_file = "HEPG2_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix.h5"

# Check if gene expression file was already downloaded and check integrity, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE)
} else{
    print("Verifying file integrity...")
    checksum = md5sum(destination_file)
    
    if(destination_file == "human_matrix_download.h5"){
        # human checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "d8810730ac56271bb2ff563e549c9988"
    } else{
        # mouse checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "afbbaaed0a696b967ce8ecb0baa86ea5"
    }
    
    if(checksum != correct_checksum){
        print("Existing file looks corrupted. Downloading compressed gene expression matrix again.")
        download.file(url, destination_file, quiet = FALSE)
    } else{
        print("Latest ARCHS4 file already exists.")
    }
}

checksum = md5sum(destination_file)
if(destination_file == "human_matrix_download.h5"){
    # human checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "d8810730ac56271bb2ff563e549c9988"
} else{
    # mouse checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "afbbaaed0a696b967ce8ecb0baa86ea5"
}

if(checksum != correct_checksum){
    print("File download ran into problems. Please try to download again. The files are also available for manual download at http://amp.pharm.mssm.edu/archs4/download.html.")
} else{
    # Selected samples to be extracted
    samp = c("GSM1704034","GSM1704023","GSM1704036","GSM1704027","GSM2228736","GSM1704021","GSM1704025","GSM1704032","GSM1704037","GSM1704028","GSM1704038","GSM2228737","GSM1975771","GSM1704024","GSM1704020","GSM1704031","GSM1975773","GSM2228735","GSM1975770","GSM1704029","GSM1975772","GSM1704022","GSM1704033","GSM2228741","GSM2228742","GSM1704030","GSM1704035","GSM1861945","GSM1861947","GSM2209496","GSM1861944",
"GSM2209494","GSM1861946","GSM2209495","GSM1704026","GSM2344350","GSM2344353","GSM2343434","GSM2343435","GSM2343291","GSM2343292","GSM2343358","GSM2343354","GSM2343605","GSM2343356","GSM2343603","GSM2343352","GSM2343971","GSM2343970","GSM2343975","GSM2343974","GSM2343977","GSM2343976","GSM2343347","GSM2343345","GSM2343555","GSM2344274","GSM2138841","GSM2138840","GSM2138843","GSM2138842",
"GSM2138847","GSM2138846","GSM2138667","GSM2138666","GSM2344094","GSM2344093","GSM2344091","GSM2343157","GSM2343156","GSM2343959","GSM2343958","GSM2072618","GSM2072617","GSM2344288","GSM2344289","GSM2138860","GSM2138864","GSM2344118","GSM2344119","GSM2344110","GSM2344117","GSM2344073","GSM2344074","GSM2343935","GSM2343936","GSM2343933","GSM2343932","GSM2343939","GSM2343424","GSM2343588",
"GSM2343237","GSM2343235","GSM2343238","GSM2343855","GSM2138805","GSM2138804","GSM2138807","GSM2138806","GSM2344135","GSM2344136","GSM2344131","GSM2344132","GSM2343919","GSM2343078","GSM2343079","GSM2138823","GSM2138822","GSM2138829","GSM2138828","GSM2344154","GSM2344153","GSM2344158","GSM2138748","GSM2138680","GSM2138686","GSM2343272","GSM2343271","GSM2343092","GSM2343090","GSM2343091",
"GSM2343096","GSM2343097","GSM2343095","GSM2343098","GSM2343890","GSM2343896","GSM2343895","GSM2344174","GSM2344175","GSM2344176","GSM2344177","GSM2344013","GSM2344012","GSM2344211","GSM2343252","GSM2343253","GSM2343257","GSM2343528","GSM2343529","GSM2138679","GSM2138678","GSM2344089","GSM2344192","GSM2344193","GSM2344198","GSM2344199","GSM2343753","GSM2343755","GSM2343754","GSM2343756",
"GSM2343504","GSM2344220","GSM2343501","GSM2343508","GSM2343509","GSM2344422","GSM2344423","GSM2344420","GSM2344421","GSM2344424","GSM2344425","GSM2344428","GSM2344429","GSM2138754","GSM2138861","GSM2138750","GSM2343197","GSM2343196","GSM2343193","GSM2343192","GSM2343771","GSM2343770","GSM2343999","GSM2343998","GSM2344249","GSM2343562","GSM2344243","GSM2343561","GSM2344402","GSM2344403",
"GSM2343617","GSM2344202","GSM2344203","GSM2138719","GSM2138718","GSM2343256","GSM2343170","GSM2344387","GSM2343177","GSM2344384","GSM2343178","GSM2344388","GSM2343714","GSM2343710","GSM2343713","GSM2072545","GSM2343542","GSM2343543","GSM2343544","GSM2343545","GSM2343818","GSM2343819","GSM2138669","GSM2138668","GSM2343246","GSM2344092","GSM2138733","GSM2138732","GSM2138731","GSM2138730",
"GSM2343736","GSM2343735","GSM2343837","GSM2343830","GSM2343831","GSM2343832","GSM2343838","GSM2344332","GSM2344333","GSM2138755","GSM2138751","GSM2343139","GSM2343134","GSM2343133","GSM2343856","GSM2138878","GSM2138879","GSM2343247","GSM2138779","GSM2138778","GSM2138775","GSM2138774","GSM2138771","GSM2138770","GSM2343440","GSM2343445","GSM2343444","GSM2344327","GSM2344326","GSM2344022",
"GSM2343658","GSM2343307","GSM2343877","GSM2343654","GSM2343308","GSM2344224","GSM2344221","GSM2138793","GSM2138792","GSM2138795","GSM2138794","GSM2344309","GSM2344302","GSM2344301","GSM2343465","GSM2343464","GSM2343799","GSM2343798","GSM2343795","GSM2343794","GSM2343791","GSM2343790","GSM2138892","GSM2138893","GSM2138898","GSM2138899","GSM2344320","GSM2343632","GSM2343633","GSM2343639",
"GSM2344325","GSM2344321","GSM2343113","GSM2344324","GSM2344363","GSM2343169","GSM2343613","GSM2343614","GSM2343616","GSM2138863","GSM2343968","GSM2343969","GSM2138862","GSM2343962","GSM2343961","GSM2343964","GSM2343965","GSM2138865","GSM2344344","GSM2344343","GSM2344342","GSM2344341","GSM2344349","GSM2344223","GSM2343287","GSM2343288","GSM2138856","GSM2138857","GSM2138676","GSM2138677",
"GSM2138674","GSM2138675","GSM2138672","GSM2138673","GSM2138670","GSM2138671","GSM2344088","GSM2344080","GSM2344081","GSM2343948","GSM2343947","GSM2343940","GSM2343988","GSM2343765","GSM2138874","GSM2138875","GSM2344062","GSM2344060","GSM2344061","GSM2344066","GSM2344065","GSM2344059","GSM2138783","GSM2343920","GSM2343477","GSM2343478","GSM2344293","GSM2344292","GSM2138816","GSM2138817",
"GSM2138814","GSM2138815","GSM2138812","GSM2138813","GSM2138810","GSM2138811","GSM2344109","GSM2344107","GSM2344106","GSM2344042","GSM2343870","GSM2343659","GSM2343878","GSM2343655","GSM2343900","GSM2343901","GSM2343513","GSM2343512","GSM2343421","GSM2343223","GSM2343225","GSM2343224","GSM2343595","GSM2343594","GSM2343229","GSM2343228","GSM2138830","GSM2138831","GSM2138836","GSM2138837",
"GSM2138838","GSM2138839","GSM2344120","GSM2344126","GSM2344125","GSM2344023","GSM2344020","GSM2344021","GSM2343690","GSM2343691","GSM2343692","GSM2343693","GSM2343697","GSM2343698","GSM2344040","GSM2344041","GSM2138689","GSM2343203","GSM2343202","GSM2344144","GSM2344147","GSM2344143","GSM2344148","GSM2343236","GSM2344004","GSM2344005","GSM2344006","GSM2344007","GSM2343587","GSM2343261",
"GSM2343260","GSM2138742","GSM2343081","GSM2343082","GSM2343089","GSM2343889","GSM2343881","GSM2343505","GSM2343748","GSM2343749","GSM2343743","GSM2343744","GSM2343502","GSM2344248","GSM2344242","GSM2343245","GSM2343244","GSM2343535","GSM2343536","GSM2344185","GSM2344184","GSM2343441","GSM2343982","GSM2343983","GSM2343989","GSM2343766","GSM2344238","GSM2344237","GSM2343604","GSM2343222",
"GSM2138708","GSM2138709","GSM2138700","GSM2138701","GSM2138704","GSM2138705","GSM2343162","GSM2343163","GSM2343161","GSM2343167","GSM2343164","GSM2344397","GSM2344392","GSM2344393","GSM2343709","GSM2343415","GSM2343413","GSM2138724","GSM2138725","GSM2138726","GSM2138727","GSM2138720","GSM2343147","GSM2343148","GSM2343498","GSM2343499","GSM2343723","GSM2343724","GSM2343727","GSM2344257",
"GSM2344256","GSM2343168","GSM2343554","GSM2344273","GSM2343801","GSM2343800","GSM2343805","GSM2343806","GSM2343114","GSM2344383","GSM2343173","GSM2343174","GSM2344398","GSM2344029","GSM2138743","GSM2138740","GSM2138741","GSM2344024","GSM2138749","GSM2344025","GSM2343640","GSM2343647","GSM2138887","GSM2138886","GSM2343829","GSM2343823","GSM2343822","GSM2072546","GSM2138900","GSM2138901",
"GSM2138902","GSM2138903","GSM2344038","GSM2138768","GSM2138769","GSM2138766","GSM2138767","GSM2344330","GSM2344331","GSM2344037","GSM2344031","GSM2344362","GSM2343332","GSM2343334","GSM2138782","GSM2138780","GSM2138786","GSM2138787","GSM2138784","GSM2138785","GSM2343474","GSM2344310","GSM2344311","GSM2344312","GSM2343473","GSM2344354","GSM2343782","GSM2343781","GSM2344052","GSM2344051",
"GSM2344266","GSM2344055","GSM2344267","GSM2344054","GSM2343606","GSM2138721","GSM2343864","GSM2343863","GSM2343646","GSM2343649","GSM2343648","GSM2343869","GSM2343140","GSM2343490","GSM2344157","GSM2343491","GSM2344210","GSM2343728","GSM2344039","GSM2344035","GSM2344034","GSM2344374","GSM2344375","GSM2344372","GSM2344373","GSM2344036","GSM2344030","GSM2344033","GSM2344032","GSM2138885",
"GSM2138884","GSM2138883","GSM2138882","GSM2138681","GSM2138687","GSM2343627","GSM2343626","GSM2343623","GSM2343622","GSM2343629","GSM2343628","GSM2197718","GSM2197716","GSM2197717","GSM2463218","GSM2463220","GSM2463221","GSM2463222","GSM2463223","GSM2463219","")

    # Retrieve information from compressed data
    samples = h5read(destination_file, "meta/Sample_geo_accession")
    tissue = h5read(destination_file, "meta/Sample_source_name_ch1")
    genes = h5read(destination_file, "meta/genes")

    # Identify columns to be extracted
    sample_locations = which(samples %in% samp)

    # extract gene expression from compressed data
    expression = h5read(destination_file, "data/expression", index=list(1:length(genes), sample_locations))
    H5close()
    rownames(expression) = genes
    colnames(expression) = samples[sample_locations]

    # Print file
    write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE)
    print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))
}
