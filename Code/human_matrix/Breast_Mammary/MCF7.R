# R script to download selected samples
# Copy code and run on a local machine to initiate download

# Check for dependencies and install if missing
packages <- c("rhdf5")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
    print("Install required packages")
    source("https://bioconductor.org/biocLite.R")
    biocLite("rhdf5")
}
library("rhdf5")
library("tools")

destination_file = "human_matrix_download.h5"
extracted_expression_file = "MCF7_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix.h5"

# Check if gene expression file was already downloaded and check integrity, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE)
} else{
    print("Verifying file integrity...")
    checksum = md5sum(destination_file)
    
    if(destination_file == "human_matrix_download.h5"){
        # human checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "d8810730ac56271bb2ff563e549c9988"
    } else{
        # mouse checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "afbbaaed0a696b967ce8ecb0baa86ea5"
    }
    
    if(checksum != correct_checksum){
        print("Existing file looks corrupted. Downloading compressed gene expression matrix again.")
        download.file(url, destination_file, quiet = FALSE)
    } else{
        print("Latest ARCHS4 file already exists.")
    }
}

checksum = md5sum(destination_file)
if(destination_file == "human_matrix_download.h5"){
    # human checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "d8810730ac56271bb2ff563e549c9988"
} else{
    # mouse checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "afbbaaed0a696b967ce8ecb0baa86ea5"
}

if(checksum != correct_checksum){
    print("File download ran into problems. Please try to download again. The files are also available for manual download at http://amp.pharm.mssm.edu/archs4/download.html.")
} else{
    # Selected samples to be extracted
    samp = c("GSM1207878","GSM1244820","GSM1006904","GSM1244811","GSM1006912","GSM1244819","GSM1116000","GSM1069746","GSM973681","GSM1115995","GSM1115997","GSM1143675","GSM942209","GSM973687","GSM1244813","GSM1244818","GSM1244812","GSM1244822","GSM1207879","GSM1244809","GSM1244821","GSM1244814","GSM981252","GSM981245","GSM973690","GSM1006905","GSM1244817","GSM942211","GSM973672","GSM973682","GSM1244816",
"GSM1244810","GSM1244815","GSM1154039","GSM973676","GSM1115999","GSM929909","GSM1115998","GSM1143674","GSM1143673","GSM1069745","GSM942210","GSM1154040","GSM1115996","GSM1143672","GSM929910","GSM2033072","GSM1669173","GSM1669175","GSM1431879","GSM2152854","GSM1900344","GSM1338772","GSM1470034","GSM1669167","GSM1669163","GSM2024863","GSM1704630","GSM1900353","GSM2024871","GSM1431880",
"GSM1897359","GSM1669180","GSM1900347","GSM1470033","GSM1847260","GSM2112494","GSM1348545","GSM1900330","GSM1669164","GSM2112495","GSM1669168","GSM2152855","GSM1669183","GSM1669179","GSM1470038","GSM2024864","GSM2024862","GSM1470036","GSM1900333","GSM1900342","GSM1470030","GSM1900346","GSM1669169","GSM1900351","GSM1348551","GSM1922705","GSM1406525","GSM1900343","GSM1669162","GSM1825454",
"GSM1900345","GSM1406524","GSM1704629","GSM1669177","GSM1543660","GSM1669166","GSM1825448","GSM1900331","GSM1462977","GSM1348549","GSM2027253","GSM2309313","GSM1825451","GSM2024870","GSM2024865","GSM1669165","GSM1543655","GSM1669172","GSM1897358","GSM1406526","GSM1922703","GSM1348957","GSM1669171","GSM1462976","GSM1543664","GSM2024872","GSM1348550","GSM1922708","GSM1348546","GSM1338773",
"GSM1470039","GSM2027259","GSM1543643","GSM1904533","GSM1897362","GSM1406527","GSM1470040","GSM2027256","GSM1470037","GSM2027255","GSM2027261","GSM2024866","GSM2024868","GSM1900341","GSM1543646","GSM1669182","GSM1825453","GSM1431878","GSM1348548","GSM1462972","GSM2027262","GSM1669161","GSM1348547","GSM1669176","GSM1825452","GSM1900338","GSM2112491","GSM1847261","GSM1462973","GSM1666033",
"GSM1431876","GSM1543662","GSM2112490","GSM1900350","GSM1669160","GSM2112492","GSM1631321","GSM1669181","GSM2027258","GSM1669170","GSM1505593","GSM1348541","GSM1543644","GSM1543650","GSM1348544","GSM1462974","GSM1682280","GSM1669174","GSM2112493","GSM1264341","GSM1666032","GSM2024869","GSM1543647","GSM2152851","GSM1543649","GSM1543657","GSM1704628","GSM1922704","GSM1900349","GSM1543659",
"GSM1431877","GSM2152852","GSM1922707","GSM2152850","GSM1470031","GSM1543648","GSM1543658","GSM2027260","GSM1682279","GSM1543653","GSM1470027","GSM1431881","GSM1543641","GSM1900339","GSM1900348","GSM2152853","GSM1431874","GSM1530029","GSM1470035","GSM1847259","GSM1543652","GSM1900335","GSM1462975","GSM2024861","GSM1264339","GSM1825447","GSM1431870","GSM1543661","GSM1847262","GSM1922706",
"GSM1431871","GSM1264338","GSM1900332","GSM1348956","GSM1406528","GSM1470032","GSM2027257","GSM2309314","GSM2309315","GSM1264340","GSM1904534","GSM1470028","GSM1470029","GSM1431873","GSM1543640","GSM1900334","GSM1704627","GSM1897361","GSM1431872","GSM2027254","GSM1348552","GSM1543645","GSM2024867","GSM1900352","GSM1530030","GSM1825450","GSM1543656","GSM1406523","GSM2027263","GSM1264343",
"GSM2027264","GSM1631320","GSM1543663","GSM1348542","GSM1543651","GSM1897360","GSM1900337","GSM1900336","GSM1264342","GSM1825449","GSM2068644","GSM2069480","GSM2069476","GSM2068667","GSM2068655","GSM1269467","GSM1944025","GSM2068650","GSM1944027","GSM2071229","GSM2068669","GSM2071230","GSM2069477","GSM2069474","GSM2068658","GSM2068651","GSM2068664","GSM2069478","GSM2069475","GSM2068652",
"GSM2068645","GSM2068646","GSM2071228","GSM1944026","GSM2071235","GSM2068653","GSM2069472","GSM2071226","GSM2071234","GSM2071236","GSM1269469","GSM2069473","GSM2071232","GSM1944028","GSM2068648","GSM2068662","GSM2068668","GSM2068672","GSM2069481","GSM2071227","GSM2068663","GSM2068643","GSM2071233","GSM2068661","GSM2068656","GSM2071231","GSM2068659","GSM2068665","GSM2069479","GSM1944030",
"GSM1944029","GSM1306495","GSM2068671","GSM2042808","GSM2068670","GSM2069482","GSM2068654","GSM2069483","GSM2068666","GSM2068649","GSM1269468","GSM2068660","GSM2068647","GSM2068657","GSM1348543","GSM1431875","GSM1543642","GSM1543654","GSM1669178","GSM1682278","GSM1897357","GSM1900340","GSM2033073","GSM1908562","GSM1908563","GSM1908560","GSM1908561","GSM1908566","GSM1908567","GSM1908564",
"GSM1908565","GSM1908548","GSM1908549","GSM1908544","GSM1908546","GSM1908547","GSM1908540","GSM1908541","GSM1908542","GSM1908553","GSM1908552","GSM1908551","GSM1908550","GSM1908557","GSM1908556","GSM1908555","GSM1908554","GSM1908559","GSM1908558","GSM1908539","GSM1908538","GSM1908545","GSM1908543","GSM2072527","GSM1415615","GSM1415614","GSM1415617","GSM1415616","GSM1415611","GSM1415610",
"GSM1415613","GSM1415612","GSM2400230","GSM2400231","GSM2400218","GSM2400219","GSM2072528","GSM897081","GSM1415608","GSM1415609","GSM1415606","GSM1415607","GSM2072571","GSM2072572","GSM979654","GSM979657","GSM1643968","GSM1643967","GSM1643966","GSM1643984","GSM1643969","GSM1643974","GSM1643971","GSM1643988","GSM1643979","GSM1643965","GSM1643983","GSM1643975","GSM1643972","GSM1643989",
"GSM1643976","GSM1643977","GSM1643985","GSM1643978","GSM1643964","GSM1643987","GSM1643982","GSM1643981","GSM1643980","GSM1643973","GSM1643986","GSM1643970","GSM1915702","GSM1915700","GSM1915701","GSM1915699","GSM1915703","GSM1915698","GSM2300036","GSM2300033","GSM2300032","GSM2300037","GSM2300035","GSM2300038","GSM2300034","GSM2300039","GSM2367473","GSM2367471","GSM2367474","GSM2367468",
"GSM2367470","GSM2367477","GSM2367466","GSM2367475","GSM2367469","GSM2367476","GSM2367486","GSM2367488","GSM2367487","GSM2367485","GSM2367499","GSM2367491","GSM2367495","GSM2367490","GSM2367493","GSM2367492","GSM2367500","GSM2367498","GSM2392614","GSM2392617","GSM2392611","GSM2392615","GSM2392606","GSM2392619","GSM2392612","GSM2392624","GSM2392629","GSM2392623","GSM2392622","GSM2392616",
"GSM2392621","GSM2392620","GSM2392613","GSM2392627","GSM2392625","GSM2392607","GSM2392618","GSM2392610","GSM2392608","GSM2392626","GSM2392628","GSM2392609","GSM2474228","GSM2474227","GSM2476256","GSM2476257","GSM2476255","GSM2537142","GSM2537141","GSM2537139","GSM2537140","")

    # Retrieve information from compressed data
    samples = h5read(destination_file, "meta/Sample_geo_accession")
    tissue = h5read(destination_file, "meta/Sample_source_name_ch1")
    genes = h5read(destination_file, "meta/genes")

    # Identify columns to be extracted
    sample_locations = which(samples %in% samp)

    # extract gene expression from compressed data
    expression = h5read(destination_file, "data/expression", index=list(1:length(genes), sample_locations))
    H5close()
    rownames(expression) = genes
    colnames(expression) = samples[sample_locations]

    # Print file
    write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE)
    print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))
}
