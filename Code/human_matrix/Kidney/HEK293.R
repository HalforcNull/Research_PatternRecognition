# R script to download selected samples
# Copy code and run on a local machine to initiate download

# Check for dependencies and install if missing
packages <- c("rhdf5")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
    print("Install required packages")
    source("https://bioconductor.org/biocLite.R")
    biocLite("rhdf5")
}
library("rhdf5")
library("tools")

destination_file = "human_matrix_download.h5"
extracted_expression_file = "HEK293_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix.h5"

# Check if gene expression file was already downloaded and check integrity, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE)
} else{
    print("Verifying file integrity...")
    checksum = md5sum(destination_file)
    
    if(destination_file == "human_matrix_download.h5"){
        # human checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "d8810730ac56271bb2ff563e549c9988"
    } else{
        # mouse checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "afbbaaed0a696b967ce8ecb0baa86ea5"
    }
    
    if(checksum != correct_checksum){
        print("Existing file looks corrupted. Downloading compressed gene expression matrix again.")
        download.file(url, destination_file, quiet = FALSE)
    } else{
        print("Latest ARCHS4 file already exists.")
    }
}

checksum = md5sum(destination_file)
if(destination_file == "human_matrix_download.h5"){
    # human checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "d8810730ac56271bb2ff563e549c9988"
} else{
    # mouse checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "afbbaaed0a696b967ce8ecb0baa86ea5"
}

if(checksum != correct_checksum){
    print("File download ran into problems. Please try to download again. The files are also available for manual download at http://amp.pharm.mssm.edu/archs4/download.html.")
} else{
    # Selected samples to be extracted
    samp = c("GSM1197328","GSM1197372","GSM1145141","GSM1081535","GSM1197375","GSM940576","GSM1145142","GSM1197331","GSM1067868","GSM1197364","GSM1067861","GSM1197334","GSM1145136","GSM1197330","GSM1197325","GSM1197346","GSM1197335","GSM1197340","GSM1197354","GSM1207921","GSM1215138","GSM1071443","GSM1140829","GSM1197365","GSM1087848","GSM1215137","GSM1145137","GSM986133","GSM1147074","GSM1081534","GSM1197332",
"GSM1197363","GSM1207918","GSM1071442","GSM1197356","GSM940575","GSM986135","GSM1067863","GSM1197339","GSM1145139","GSM1197351","GSM986134","GSM1197343","GSM1197326","GSM1197368","GSM1197355","GSM1197361","GSM1197373","GSM1081538","GSM1197376","GSM1207920","GSM1197329","GSM1207922","GSM1197342","GSM1147075","GSM986136","GSM1145138","GSM1197362","GSM1197352","GSM1087851","GSM1145140",
"GSM1197350","GSM1197353","GSM1067864","GSM1067866","GSM1197370","GSM1197348","GSM1197338","GSM1197327","GSM1197324","GSM1081540","GSM1081536","GSM1071440","GSM1249877","GSM1081539","GSM1249876","GSM955513","GSM1071439","GSM955512","GSM1081537","GSM1197345","GSM1147076","GSM1197347","GSM1197367","GSM1197366","GSM1145330","GSM1249874","GSM1197379","GSM1197341","GSM921129","GSM1071441",
"GSM1145329","GSM1215136","GSM1197349","GSM1197358","GSM909243","GSM1197371","GSM1081541","GSM909244","GSM1197357","GSM1197369","GSM1197360","GSM1197378","GSM909245","GSM1197377","GSM1245900","GSM1197344","GSM1207919","GSM986138","GSM909242","GSM1067862","GSM1197333","GSM986137","GSM1197337","GSM1197374","GSM1197336","GSM1215135","GSM1249878","GSM1249875","GSM1067865","GSM1197359",
"GSM1496417","GSM2026914","GSM1279922","GSM2026957","GSM2026982","GSM2155552","GSM1373308","GSM2011519","GSM2243398","GSM1606106","GSM2026955","GSM2155554","GSM1677108","GSM2011515","GSM1612421","GSM1901280","GSM2026918","GSM2026967","GSM1440611","GSM2026969","GSM2011517","GSM2026946","GSM1331347","GSM1479598","GSM2026979","GSM2026916","GSM1606105","GSM1668816","GSM2026991","GSM2243390",
"GSM2026938","GSM1899545","GSM2026951","GSM1606109","GSM2155553","GSM1275183","GSM2011512","GSM1606112","GSM2155550","GSM2026927","GSM1267852","GSM1899541","GSM2026978","GSM2026981","GSM1677100","GSM1668813","GSM1899540","GSM1606099","GSM1440619","GSM1373309","GSM2243391","GSM1612425","GSM2026985","GSM1366346","GSM1275184","GSM2026948","GSM2026959","GSM2026935","GSM2026973","GSM2026975",
"GSM2011520","GSM1606103","GSM2026974","GSM1440618","GSM1677106","GSM1553198","GSM1659005","GSM1290633","GSM2026950","GSM1440615","GSM1720812","GSM1612424","GSM1553202","GSM2011522","GSM1677105","GSM2026971","GSM1382453","GSM2026905","GSM2026983","GSM2026933","GSM1659004","GSM1901283","GSM2011504","GSM2026911","GSM2026972","GSM1612420","GSM2026949","GSM1373312","GSM1901281","GSM1612426",
"GSM2243387","GSM2026968","GSM2026926","GSM2243393","GSM2026902","GSM1899543","GSM1606113","GSM1899542","GSM1440614","GSM2011506","GSM2026940","GSM1440304","GSM1720810","GSM2243388","GSM1427354","GSM1440620","GSM2026932","GSM1677102","GSM2026965","GSM1331349","GSM1612428","GSM1496415","GSM1612427","GSM2026990","GSM1668817","GSM2026984","GSM1267858","GSM2155549","GSM2026952","GSM1267847",
"GSM1668818","GSM2026944","GSM2026953","GSM2026934","GSM1290632","GSM1382451","GSM2026922","GSM1440307","GSM1440306","GSM1267846","GSM1553206","GSM2026962","GSM2243392","GSM1606104","GSM1440617","GSM2026930","GSM2011502","GSM2026943","GSM1373307","GSM1276541","GSM1677104","GSM2026988","GSM1494770","GSM2243385","GSM2026931","GSM1606100","GSM2011508","GSM1382446","GSM1606102","GSM2026963",
"GSM2026919","GSM1382452","GSM2026964","GSM1373314","GSM2011513","GSM1373310","GSM2011518","GSM1606107","GSM2026960","GSM1553201","GSM2026915","GSM1373306","GSM2243397","GSM1366347","GSM1553197","GSM1496416","GSM2026970","GSM2026941","GSM2243384","GSM1901282","GSM1373311","GSM1440613","GSM1359854","GSM2026936","GSM1668820","GSM2243400","GSM2011507","GSM1612422","GSM1279924","GSM1359855",
"GSM1677847","GSM1382445","GSM2026929","GSM1606114","GSM1677849","GSM1668815","GSM2243394","GSM1677848","GSM2026977","GSM1427355","GSM1440610","GSM2243389","GSM1440622","GSM1553204","GSM1427351","GSM1677107","GSM2011523","GSM1494768","GSM1677110","GSM2011516","GSM2243404","GSM2026986","GSM2026910","GSM2026976","GSM1677103","GSM1553196","GSM2026992","GSM2026923","GSM2026920","GSM2026913",
"GSM1479597","GSM1382449","GSM1606108","GSM2026958","GSM1553200","GSM1427356","GSM2155551","GSM2243401","GSM1427353","GSM2011503","GSM2026939","GSM1901284","GSM2011510","GSM2026961","GSM2026993","GSM2026928","GSM1720808","GSM2011505","GSM1494766","GSM1331346","GSM2026912","GSM2026907","GSM2243396","GSM1279923","GSM2243386","GSM1668819","GSM2026954","GSM1440305","GSM1677109","GSM2026917",
"GSM1553205","GSM2026956","GSM1479599","GSM1606101","GSM1276542","GSM1382447","GSM1479600","GSM2243399","GSM2243402","GSM1440616","GSM1382450","GSM2026908","GSM1331348","GSM1720809","GSM1606111","GSM1659010","GSM2243395","GSM1440612","GSM2026906","GSM2011514","GSM2011525","GSM1677101","GSM1553203","GSM1382448","GSM2243403","GSM2011524","GSM1553199","GSM1440621","GSM1267859","GSM2026947",
"GSM2026937","GSM1494769","GSM2026980","GSM1427352","GSM2011511","GSM2026925","GSM1899544","GSM2026989","GSM2026921","GSM1659006","GSM2026909","GSM2011509","GSM1720811","GSM2026942","GSM2026904","GSM1553195","GSM1529689","GSM1701747","GSM1631262","GSM2310336","GSM1631269","GSM1906578","GSM1906583","GSM1906571","GSM1495271","GSM1368019","GSM1698486","GSM1906576","GSM1631265","GSM1701758",
"GSM1698479","GSM1529688","GSM1495270","GSM1906563","GSM1698478","GSM1631490","GSM1819237","GSM1631273","GSM1819232","GSM1698474","GSM1631271","GSM1631272","GSM1368021","GSM1701755","GSM1269465","GSM1906575","GSM1906570","GSM1306496","GSM1906568","GSM1819231","GSM1687389","GSM2131631","GSM1698481","GSM1290637","GSM1701748","GSM1701752","GSM1701754","GSM1631496","GSM1368024","GSM2154963",
"GSM1701756","GSM1698482","GSM1698484","GSM1819236","GSM1290635","GSM1631497","GSM1368020","GSM1529692","GSM1529691","GSM1906573","GSM1906581","GSM1698487","GSM1843476","GSM2131628","GSM2131630","GSM1906569","GSM1269464","GSM2131627","GSM1906566","GSM1701749","GSM1368022","GSM1495273","GSM1631266","GSM1698476","GSM1698485","GSM1495269","GSM1698480","GSM1529690","GSM1906565","GSM1819229",
"GSM1290638","GSM1631263","GSM1631267","GSM1906584","GSM1906561","GSM1698475","GSM1698472","GSM1698470","GSM1906574","GSM1906564","GSM1368023","GSM1906577","GSM2131626","GSM1290641","GSM1819234","GSM1370364","GSM1714397","GSM1631494","GSM1701750","GSM2131625","GSM2131634","GSM1843475","GSM1819238","GSM1631492","GSM1906580","GSM1631491","GSM2131633","GSM2154964","GSM1819230","GSM1819240",
"GSM1698471","GSM1701751","GSM1290634","GSM1290636","GSM1687388","GSM1290640","GSM1698473","GSM1687391","GSM1819239","GSM1269466","GSM1819235","GSM1687390","GSM1631499","GSM1631264","GSM1714396","GSM1701757","GSM1631493","GSM2131629","GSM1290639","GSM1906582","GSM1906562","GSM1698483","GSM1495272","GSM2131632","GSM1701753","GSM1819233","GSM1906572","GSM1495268","GSM1906579","GSM1906567",
"GSM1631495","GSM1631498","GSM1631268","GSM1698477","GSM1631270","GSM1267853","GSM1494767","GSM1359853","GSM1373313","GSM1606110","GSM1612423","GSM1668821","GSM1677846","GSM1677099","GSM1948532","GSM1948530","GSM1948529","GSM1948531","GSM2011521","GSM2026966","GSM2026924","GSM2026903","GSM2026945","GSM2026987","GSM2065365","GSM2065364","GSM2065367","GSM2065366","GSM2065361","GSM2065360",
"GSM2065363","GSM2065362","GSM2065369","GSM2065368","GSM2340158","GSM2340159","GSM2065358","GSM2065359","GSM2340160","GSM2340170","GSM2340171","GSM2340172","GSM2340169","GSM2340162","GSM2340161","GSM2361184","GSM2361185","GSM2361186","GSM2361182","GSM2361183","GSM1269354","GSM1269353","GSM1269355","GSM1269351","GSM1269352","GSM1269350","GSM2061462","GSM2061452","GSM2061449","GSM2061469",
"GSM2061457","GSM2061455","GSM2061454","GSM2061451","GSM2061468","GSM2061465","GSM2061467","GSM2061459","GSM2061458","GSM2061461","GSM2061460","GSM2061464","GSM2061466","GSM2061450","GSM2061453","GSM2061456","GSM2061463","GSM2221672","GSM2221670","GSM2221669","GSM2221671","GSM2253103","GSM2253104","GSM2253105","GSM2375978","GSM2375979","GSM2375980","GSM2375977","GSM2458760","GSM2458766",
"GSM2458757","GSM2458767","GSM2458758","GSM2458768","GSM2458755","GSM2474566","GSM2474568","GSM2458761","GSM2458756","GSM2458765","GSM2458803","GSM2458807","GSM2458802","GSM2458799","GSM2458800","GSM2458806","GSM2458805","GSM2458801","GSM2458804","GSM2459865","GSM2459870","GSM2459866","GSM2459864","GSM2459868","GSM2459867","GSM2459869","GSM2459871","GSM2459872","GSM2563640","GSM2563639",
"GSM2563641","GSM2563630","GSM2563632","GSM2563644","GSM2563633","GSM2563631","GSM2563642","GSM2563635","GSM2563636","GSM2563645","GSM2563638","GSM2563646","GSM2563637","GSM2563634","GSM2563643","GSM2563629","GSM2584551","GSM2584561","GSM2584548","GSM2584550","GSM2584544","GSM2584559","GSM2584558","GSM2584555","GSM2584567","GSM2584553","GSM2584565","GSM2584557","GSM2584552","GSM2584549",
"GSM2584545","GSM2584554","GSM2584547","GSM2584563","GSM2584566","GSM2584560","GSM2584564","GSM2584556","GSM2584562","GSM2584546","GSM2643631","GSM2643633","GSM2643632","GSM2643634","")

    # Retrieve information from compressed data
    samples = h5read(destination_file, "meta/Sample_geo_accession")
    tissue = h5read(destination_file, "meta/Sample_source_name_ch1")
    genes = h5read(destination_file, "meta/genes")

    # Identify columns to be extracted
    sample_locations = which(samples %in% samp)

    # extract gene expression from compressed data
    expression = h5read(destination_file, "data/expression", index=list(1:length(genes), sample_locations))
    H5close()
    rownames(expression) = genes
    colnames(expression) = samples[sample_locations]

    # Print file
    write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE)
    print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))
}
