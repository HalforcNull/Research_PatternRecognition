# R script to download selected samples
# Copy code and run on a local machine to initiate download

# Check for dependencies and install if missing
packages <- c("rhdf5")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
    print("Install required packages")
    source("https://bioconductor.org/biocLite.R")
    biocLite("rhdf5")
}
library("rhdf5")
library("tools")

destination_file = "human_matrix_download.h5"
extracted_expression_file = "K562_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix.h5"

# Check if gene expression file was already downloaded and check integrity, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE)
} else{
    print("Verifying file integrity...")
    checksum = md5sum(destination_file)
    
    if(destination_file == "human_matrix_download.h5"){
        # human checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "d8810730ac56271bb2ff563e549c9988"
    } else{
        # mouse checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "afbbaaed0a696b967ce8ecb0baa86ea5"
    }
    
    if(checksum != correct_checksum){
        print("Existing file looks corrupted. Downloading compressed gene expression matrix again.")
        download.file(url, destination_file, quiet = FALSE)
    } else{
        print("Latest ARCHS4 file already exists.")
    }
}

checksum = md5sum(destination_file)
if(destination_file == "human_matrix_download.h5"){
    # human checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "d8810730ac56271bb2ff563e549c9988"
} else{
    # mouse checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "afbbaaed0a696b967ce8ecb0baa86ea5"
}

if(checksum != correct_checksum){
    print("File download ran into problems. Please try to download again. The files are also available for manual download at http://amp.pharm.mssm.edu/archs4/download.html.")
} else{
    # Selected samples to be extracted
    samp = c("GSM999534","GSM854410","GSM999528","GSM999535","GSM999527","GSM999536","GSM999537","GSM854411","GSM999531","GSM854405","GSM999532","GSM999530","GSM999529","GSM1129239","GSM854406","GSM798059","GSM1145333","GSM999533","GSM798058","GSM854409","GSM1145334","GSM798057","GSM854404","GSM854408","GSM854407","GSM1940186","GSM1505590","GSM1838574","GSM1838576","GSM1590460","GSM1641263",
"GSM1831907","GSM1831909","GSM1940185","GSM1289409","GSM1838578","GSM1940180","GSM1940188","GSM1831904","GSM1940173","GSM1940171","GSM1940181","GSM1940183","GSM1940168","GSM1940165","GSM1641262","GSM1831903","GSM1338770","GSM1831901","GSM1590462","GSM1338771","GSM1838577","GSM1838575","GSM1940182","GSM1940176","GSM1831905","GSM1940189","GSM1641264","GSM1940184","GSM1940177","GSM1831908",
"GSM1940170","GSM1940187","GSM1940175","GSM1940178","GSM1940167","GSM1831902","GSM1289404","GSM1940164","GSM1831906","GSM1940166","GSM1940169","GSM1940179","GSM1940174","GSM1289408","GSM1289405","GSM1590464","GSM2176397","GSM1838415","GSM1838405","GSM1838416","GSM1838417","GSM1838409","GSM1838413","GSM2176396","GSM1838406","GSM1838411","GSM1838414","GSM1838412","GSM1838408","GSM1838410",
"GSM1838419","GSM1838418","GSM1838407","GSM2176398","GSM1505592","GSM1838573","GSM1940172","GSM2114218","GSM2114217","GSM2114216","GSM2114219","GSM2114223","GSM2114222","GSM2114220","GSM2114227","GSM2114225","GSM2114221","GSM2114229","GSM2114230","GSM2114226","GSM2114228","GSM2114224","GSM2344356","GSM2343437","GSM2343438","GSM2344359","GSM2343299","GSM2343294","GSM2343290","GSM2343293",
"GSM2343557","GSM2343556","GSM2343551","GSM2343550","GSM2343866","GSM2138849","GSM2138848","GSM2344098","GSM2344097","GSM2344096","GSM2344095","GSM2343376","GSM2343374","GSM2343372","GSM2343370","GSM2343953","GSM2343952","GSM2343951","GSM2343950","GSM2343957","GSM2343956","GSM2138697","GSM2344280","GSM2138695","GSM2072370","GSM2072371","GSM2138690","GSM2138691","GSM2138868","GSM2344112",
"GSM2344111","GSM2344070","GSM2344075","GSM2344076","GSM2343937","GSM2343931","GSM2343930","GSM2343938","GSM2343428","GSM2343234","GSM2343584","GSM2343585","GSM2343239","GSM2138809","GSM2138808","GSM2138801","GSM2138800","GSM2138803","GSM2138802","GSM2344138","GSM2344139","GSM2344134","GSM2344137","GSM2344130","GSM2344133","GSM2343916","GSM2343915","GSM2343914","GSM2343913","GSM2343912",
"GSM2343911","GSM2343910","GSM2343436","GSM2343214","GSM2343215","GSM2343439","GSM2343219","GSM2343075","GSM2343076","GSM2344406","GSM1289400","GSM2138827","GSM2138825","GSM2138824","GSM2344152","GSM2344150","GSM2343685","GSM2343683","GSM2343682","GSM2343681","GSM2343680","GSM2138685","GSM2343278","GSM2343279","GSM2343276","GSM2343277","GSM2343274","GSM2343275","GSM2343273","GSM2343419",
"GSM2343093","GSM2343094","GSM2343898","GSM2343899","GSM2343892","GSM2343893","GSM2343891","GSM2343894","GSM2344178","GSM2344179","GSM2138851","GSM2344017","GSM2344015","GSM2344014","GSM2344011","GSM2344010","GSM2344018","GSM2343511","GSM2343250","GSM2343251","GSM2343258","GSM2343259","GSM2138738","GSM2344190","GSM2344191","GSM2344196","GSM2344197","GSM2344194","GSM2344195","GSM2343475",
"GSM2343759","GSM2343751","GSM2343750","GSM2343457","GSM2343199","GSM2343198","GSM2343195","GSM2343194","GSM2343191","GSM2343190","GSM2343997","GSM2343996","GSM2343991","GSM2343990","GSM2343568","GSM2343566","GSM2343567","GSM2343565","GSM2344240","GSM2343382","GSM2343380","GSM2343385","GSM2344408","GSM2138845","GSM2138844","GSM2343311","GSM2138711","GSM2138710","GSM2138713","GSM2138712",
"GSM2138715","GSM2138714","GSM2138717","GSM2138716","GSM2343171","GSM2343172","GSM2344386","GSM2343715","GSM2343717","GSM2343716","GSM2343718","GSM2343540","GSM2343546","GSM2343547","GSM2343548","GSM2343549","GSM2343815","GSM2138665","GSM2138664","GSM2138737","GSM2138736","GSM2138735","GSM2138734","GSM2138739","GSM2343153","GSM2343150","GSM2343155","GSM2343154","GSM2343485","GSM2343484",
"GSM2343480","GSM2343482","GSM2343739","GSM2343734","GSM2343733","GSM2343378","GSM2343835","GSM2343836","GSM2343103","GSM2343104","GSM2343454","GSM2343459","GSM2138757","GSM2138756","GSM2138759","GSM2138758","GSM2343135","GSM2343137","GSM2343136","GSM2343131","GSM2343130","GSM2343132","GSM2343676","GSM2343853","GSM2343851","GSM2343858","GSM2343859","GSM2343857","GSM2343854","GSM2343677",
"GSM2343674","GSM2343675","GSM2138876","GSM2071264","GSM2071263","GSM2138777","GSM2138776","GSM2343532","GSM2343243","GSM2343242","GSM2343117","GSM2343443","GSM2343442","GSM2343449","GSM2344328","GSM2343240","GSM2343119","GSM2343671","GSM1289399","GSM2343302","GSM2343871","GSM2343872","GSM2343301","GSM2343304","GSM2343879","GSM2343650","GSM2343651","GSM2343652","GSM2343653","GSM2138791",
"GSM2138790","GSM2138797","GSM2138796","GSM2138799","GSM2138798","GSM2343468","GSM2343460","GSM2343467","GSM2344306","GSM2343797","GSM2343796","GSM2343141","GSM2138896","GSM2138897","GSM2138894","GSM2138895","GSM2138890","GSM2138891","GSM2343636","GSM2343635","GSM2343322","GSM2344329","GSM2343116","GSM2344323","GSM2344322","GSM2344206","GSM2344207","GSM2343408","GSM2344365","GSM2344367",
"GSM2344366","GSM2343400","GSM2343402","GSM2343618","GSM2343619","GSM2343611","GSM2343612","GSM2343343","GSM2343341","GSM2343663","GSM2343846","GSM2343665","GSM2138869","GSM2343667","GSM2343666","GSM2343966","GSM2343967","GSM2138867","GSM2138866","GSM2344347","GSM2344346","GSM2344345","GSM2344340","GSM2344348","GSM2344228","GSM2344229","GSM2343282","GSM2343281","GSM2343280","GSM2343286",
"GSM2343285","GSM2343289","GSM2343121","GSM2138852","GSM2138853","GSM2138850","GSM2138854","GSM2138855","GSM2138858","GSM2138859","GSM2344083","GSM2344084","GSM2343945","GSM2343946","GSM2343941","GSM2343942","GSM2343768","GSM2343769","GSM2138877","GSM2138870","GSM2138871","GSM2138872","GSM2138873","GSM2344063","GSM2344067","GSM2344064","GSM2344068","GSM2344069","GSM2343922","GSM2343921",
"GSM2344314","GSM2343476","GSM2344313","GSM2343479","GSM2344418","GSM2344298","GSM2344295","GSM2344297","GSM2344296","GSM2072361","GSM2072360","GSM2072363","GSM2072362","GSM2072365","GSM2072364","GSM2072367","GSM2072366","GSM2072369","GSM2072368","GSM2138818","GSM2138819","GSM2344108","GSM2344103","GSM2344104","GSM2344043","GSM2343303","GSM2343300","GSM2343873","GSM2343874","GSM2343902",
"GSM2343903","GSM2343905","GSM2343906","GSM2343852","GSM2138789","GSM2343510","GSM2343517","GSM2343425","GSM2343593","GSM2343220","GSM2343590","GSM2343598","GSM2343686","GSM2138832","GSM2138833","GSM2138834","GSM2138835","GSM2344183","GSM2344123","GSM2344122","GSM2344121","GSM2344127","GSM2344124","GSM2344129","GSM2344128","GSM2343694","GSM2343695","GSM2344044","GSM2344045","GSM2344046",
"GSM2344409","GSM2343208","GSM2343207","GSM2343206","GSM2343205","GSM2072496","GSM2072495","GSM2138684","GSM2344140","GSM2344149","GSM2344008","GSM2344009","GSM2343586","GSM2344308","GSM2344307","GSM2344305","GSM2138747","GSM2343269","GSM2343268","GSM2343265","GSM2343264","GSM2343267","GSM2343266","GSM2343263","GSM2343262","GSM2343083","GSM2343084","GSM2343087","GSM2343088","GSM2343880",
"GSM2344167","GSM2344166","GSM2344165","GSM2344164","GSM2344163","GSM2344162","GSM2344160","GSM2343644","GSM2343740","GSM2344241","GSM2343531","GSM2343539","GSM2343538","GSM2343249","GSM2343248","GSM2344187","GSM2344188","GSM2343180","GSM2343181","GSM2343182","GSM2343183","GSM2343184","GSM2343185","GSM2343186","GSM2343984","GSM2343985","GSM2343986","GSM2343987","GSM2343764","GSM2343448",
"GSM2343760","GSM2343763","GSM2343537","GSM2344233","GSM2344232","GSM2343516","GSM2343592","GSM2343591","GSM2343597","GSM2344407","GSM2138702","GSM2138703","GSM2138706","GSM2138707","GSM2343166","GSM2343165","GSM2344394","GSM2344395","GSM2344390","GSM2344391","GSM2343704","GSM2343703","GSM2343708","GSM2343411","GSM2343579","GSM2343578","GSM2344255","GSM2344254","GSM2343577","GSM2343576",
"GSM2343571","GSM2343572","GSM2343398","GSM2343396","GSM2344413","GSM2344411","GSM2344410","GSM2344417","GSM1289401","GSM2343324","GSM2138728","GSM2138729","GSM2138722","GSM2138723","GSM2343144","GSM2343497","GSM2343494","GSM2343492","GSM2343493","GSM2343142","GSM2343143","GSM2343149","GSM2343720","GSM2343721","GSM2343575","GSM2343574","GSM2344277","GSM2344276","GSM2344275","GSM2344271",
"GSM2344270","GSM2344279","GSM2344278","GSM2343803","GSM2343802","GSM2343807","GSM2343808","GSM2344182","GSM2344385","GSM2343643","GSM2138746","GSM2138744","GSM2138745","GSM2343129","GSM2343126","GSM2343127","GSM2343124","GSM2343122","GSM2343123","GSM2343120","GSM2344355","GSM2138889","GSM2343821","GSM2343820","GSM2344414","GSM2138760","GSM2138761","GSM2138762","GSM2138763","GSM2138764",
"GSM2138765","GSM2343452","GSM2343453","GSM2343456","GSM2344337","GSM2343455","GSM2344338","GSM2344339","GSM2344364","GSM2344360","GSM2344379","GSM2343661","GSM2343668","GSM2343848","GSM2343845","GSM2343660","GSM2343847","GSM2343664","GSM2343843","GSM2343842","GSM2138826","GSM2138788","GSM2344315","GSM2344316","GSM2344318","GSM2344319","GSM2343788","GSM2343789","GSM2343784","GSM2343783",
"GSM2344262","GSM2344263","GSM2343867","GSM2343642","GSM2343645","GSM2343860","GSM2343310","GSM2343496","GSM2343145","GSM2343146","GSM2343495","GSM2343312","GSM2344151","GSM2343315","GSM2343812","GSM2343813","GSM2343314","GSM2343810","GSM2343811","GSM2344159","GSM2343814","GSM2344213","GSM2344214","GSM2344217","GSM2344216","GSM2344378","GSM2343417","GSM2344370","GSM2344371","GSM2138881",
"GSM2138880","GSM2138888","GSM2138683","GSM2138682","GSM2343339","GSM2343337","GSM2343621","GSM2343620","GSM2470065","GSM2470066","GSM2610777","GSM2610831","GSM2610778","GSM2610830","GSM2610771","GSM2610829","GSM2610789","GSM2610786","GSM2610772","GSM2610823","GSM2610843","GSM2610801","GSM2610800","GSM2610783","GSM2610784","GSM2610828","GSM2610850","GSM2610768","GSM2610837","GSM2610818",
"GSM2610841","GSM2610780","GSM2610817","GSM2610787","GSM2610824","GSM2610845","GSM2610847","GSM2610825","GSM2610839","GSM2610856","GSM2610802","GSM2610775","GSM2610834","GSM2610840","GSM2610798","GSM2610821","GSM2610848","GSM2610851","GSM2610776","GSM2610826","GSM2610842","GSM2610819","GSM2610803","GSM2610773","GSM2610827","GSM2610774","GSM2610790","GSM2610858","GSM2610799","GSM2610797",
"GSM2610849","GSM2610779","GSM2610807","GSM2610838","GSM2610836","GSM2610816","GSM2610788","GSM2610770","GSM2610782","GSM2610835","GSM2610863","GSM2610833","GSM2610811","GSM2610785","GSM2610844","GSM2610814","GSM2610860","GSM2610855","GSM2610854","GSM2610810","GSM2610861","GSM2610781","GSM2610793","GSM2610815","GSM2610792","GSM2610813","GSM2610806","GSM2610862","GSM2610795","GSM2610791",
"GSM2610809","GSM2610859","GSM2610804","GSM2610796","GSM2610820","GSM2610822","GSM2610794","GSM2610805","GSM2610857","GSM2610808","GSM2610853","GSM2610812","GSM2610852","")

    # Retrieve information from compressed data
    samples = h5read(destination_file, "meta/Sample_geo_accession")
    tissue = h5read(destination_file, "meta/Sample_source_name_ch1")
    genes = h5read(destination_file, "meta/genes")

    # Identify columns to be extracted
    sample_locations = which(samples %in% samp)

    # extract gene expression from compressed data
    expression = h5read(destination_file, "data/expression", index=list(1:length(genes), sample_locations))
    H5close()
    rownames(expression) = genes
    colnames(expression) = samples[sample_locations]

    # Print file
    write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE)
    print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))
}
