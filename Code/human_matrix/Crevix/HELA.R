# R script to download selected samples
# Copy code and run on a local machine to initiate download

# Check for dependencies and install if missing
packages <- c("rhdf5")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
    print("Install required packages")
    source("https://bioconductor.org/biocLite.R")
    biocLite("rhdf5")
}
library("rhdf5")
library("tools")

destination_file = "human_matrix_download.h5"
extracted_expression_file = "HELA_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix.h5"

# Check if gene expression file was already downloaded and check integrity, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE)
} else{
    print("Verifying file integrity...")
    checksum = md5sum(destination_file)
    
    if(destination_file == "human_matrix_download.h5"){
        # human checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "d8810730ac56271bb2ff563e549c9988"
    } else{
        # mouse checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "afbbaaed0a696b967ce8ecb0baa86ea5"
    }
    
    if(checksum != correct_checksum){
        print("Existing file looks corrupted. Downloading compressed gene expression matrix again.")
        download.file(url, destination_file, quiet = FALSE)
    } else{
        print("Latest ARCHS4 file already exists.")
    }
}

checksum = md5sum(destination_file)
if(destination_file == "human_matrix_download.h5"){
    # human checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "d8810730ac56271bb2ff563e549c9988"
} else{
    # mouse checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "afbbaaed0a696b967ce8ecb0baa86ea5"
}

if(checksum != correct_checksum){
    print("File download ran into problems. Please try to download again. The files are also available for manual download at http://amp.pharm.mssm.edu/archs4/download.html.")
} else{
    # Selected samples to be extracted
    samp = c("GSM741172","GSM741170","GSM741171","GSM1098188","GSM1048186","GSM1126809","GSM1098182","GSM1174218","GSM1212183","GSM1197626","GSM1105746","GSM1241333","GSM1003587","GSM1126813","GSM1197629","GSM1148892","GSM1241330","GSM1148896","GSM1126810","GSM1098187","GSM1212182","GSM1197630","GSM1241335","GSM1241336","GSM1163976","GSM978500","GSM1098180","GSM1155630","GSM1163973","GSM1212187","GSM1207923",
"GSM1174219","GSM1197627","GSM1241334","GSM1163975","GSM1001332","GSM1212189","GSM1197623","GSM1098183","GSM1197610","GSM1098184","GSM1174216","GSM1241328","GSM1155632","GSM1174215","GSM1098185","GSM1148894","GSM1207924","GSM1174214","GSM1197620","GSM986110","GSM1155631","GSM1145331","GSM1104373","GSM1212186","GSM1126811","GSM1163974","GSM1197613","GSM1098181","GSM1241332","GSM1126816",
"GSM1126812","GSM1133259","GSM1126814","GSM1197617","GSM1173504","GSM1197628","GSM1163977","GSM1212188","GSM1197625","GSM1241329","GSM1003588","GSM1212184","GSM1197622","GSM1098186","GSM1197633","GSM986109","GSM1148891","GSM978498","GSM1197624","GSM1105745","GSM1148895","GSM1212180","GSM1104374","GSM1133260","GSM1098189","GSM1148893","GSM1212181","GSM1197631","GSM1197632","GSM1212185",
"GSM1241331","GSM978497","GSM978499","GSM978502","GSM1003589","GSM1145332","GSM1173503","GSM1197615","GSM978501","GSM1126815","GSM1197611","GSM1174217","GSM2309462","GSM2152787","GSM2228468","GSM2309466","GSM2228467","GSM2309473","GSM1969179","GSM1540973","GSM1505591","GSM2309469","GSM2100590","GSM1540975","GSM2309504","GSM1954528","GSM1420630","GSM1420626","GSM1826785","GSM1288867",
"GSM1611600","GSM1856267","GSM1826784","GSM1611602","GSM2152785","GSM2309494","GSM2309481","GSM2306248","GSM1969184","GSM2309453","GSM2061349","GSM1898015","GSM2306240","GSM2228470","GSM1898014","GSM2306247","GSM2309510","GSM2061347","GSM1969192","GSM2309458","GSM1611601","GSM1420627","GSM2309447","GSM2309467","GSM1551065","GSM2309464","GSM1505446","GSM2061348","GSM2228466","GSM1288874",
"GSM2309471","GSM1288872","GSM1898006","GSM1308595","GSM2100588","GSM1436043","GSM2309503","GSM1369389","GSM1436039","GSM2309493","GSM2262464","GSM1540966","GSM1561267","GSM1826780","GSM2309480","GSM2309441","GSM1969190","GSM1898008","GSM1288873","GSM2309459","GSM1405094","GSM1954524","GSM1288868","GSM1969181","GSM2090898","GSM2309513","GSM1856263","GSM1288876","GSM1826778","GSM2309470",
"GSM1420632","GSM1505445","GSM2262465","GSM1826774","GSM1856266","GSM1540970","GSM1531414","GSM2309485","GSM2100593","GSM1531413","GSM1411621","GSM2309477","GSM1551064","GSM2228471","GSM1856264","GSM1826781","GSM1531416","GSM1856271","GSM1954527","GSM1954525","GSM1602362","GSM1289407","GSM2309444","GSM2309508","GSM2309450","GSM1969185","GSM2309451","GSM2309482","GSM1856272","GSM2309500",
"GSM2309497","GSM1436047","GSM1690214","GSM2228465","GSM1540974","GSM1540968","GSM2306239","GSM1602361","GSM2309505","GSM1531418","GSM2228469","GSM2309475","GSM1561268","GSM1405096","GSM2228464","GSM1420631","GSM1969182","GSM2061346","GSM2309468","GSM1898009","GSM2152784","GSM1436045","GSM2309479","GSM1826776","GSM1467410","GSM1420625","GSM1856273","GSM1969188","GSM2309492","GSM1969177",
"GSM1969180","GSM1969186","GSM2309448","GSM1288875","GSM2100589","GSM2309478","GSM1467413","GSM2152786","GSM1531415","GSM1716872","GSM1531417","GSM2100587","GSM1540969","GSM1856268","GSM1602364","GSM2309511","GSM2309439","GSM1954529","GSM2309506","GSM2309454","GSM1540971","GSM1690212","GSM2309445","GSM1288869","GSM2309442","GSM2309472","GSM1405095","GSM1969193","GSM2309488","GSM1969191",
"GSM1856270","GSM1289402","GSM2309489","GSM2306246","GSM1954526","GSM1467409","GSM1288878","GSM2309502","GSM1716874","GSM1969194","GSM2309440","GSM1436040","GSM2309446","GSM2309443","GSM2309463","GSM2309449","GSM1969183","GSM1856265","GSM2100595","GSM2309474","GSM2306243","GSM2309491","GSM1467412","GSM1898017","GSM1420633","GSM1467411","GSM1716875","GSM2309490","GSM2309495","GSM2309501",
"GSM2309483","GSM1467408","GSM2228463","GSM1856269","GSM1505444","GSM1513347","GSM1369391","GSM2152782","GSM2100591","GSM1540967","GSM1969178","GSM1405099","GSM2309509","GSM2309456","GSM1826777","GSM2309496","GSM2309507","GSM2309484","GSM2309487","GSM2309457","GSM1405098","GSM1308594","GSM1436046","GSM1561269","GSM1405101","GSM2061344","GSM1826779","GSM1436042","GSM1716871","GSM1288866",
"GSM1856262","GSM2306241","GSM2100592","GSM1826775","GSM1826783","GSM2309512","GSM1467406","GSM2309438","GSM2090896","GSM1898007","GSM1467407","GSM2306242","GSM2309498","GSM2090895","GSM1436041","GSM2309486","GSM2061345","GSM1436048","GSM1436044","GSM1602363","GSM1289406","GSM1540972","GSM1690210","GSM1690209","GSM2090897","GSM1561266","GSM2306244","GSM2306245","GSM1969187","GSM2306237",
"GSM1289403","GSM1716873","GSM1405100","GSM1405097","GSM1826782","GSM2309461","GSM2309499","GSM1690213","GSM2309452","GSM2309465","GSM2309460","GSM1853598","GSM1621379","GSM1575586","GSM1922975","GSM1922977","GSM1575584","GSM1922982","GSM1922979","GSM1853578","GSM1575582","GSM1551898","GSM2059226","GSM2308955","GSM1575573","GSM1552216","GSM1922980","GSM1853587","GSM2282039","GSM1575585",
"GSM1853575","GSM1503906","GSM1440657","GSM1575577","GSM2059222","GSM1922976","GSM1552213","GSM1922981","GSM1853556","GSM1575579","GSM1922974","GSM1853605","GSM1575581","GSM2308959","GSM1575576","GSM2308957","GSM1552212","GSM1370361","GSM1853545","GSM1575583","GSM1853568","GSM1308258","GSM1853573","GSM1853551","GSM1308257","GSM2308961","GSM1503905","GSM1558745","GSM1853584","GSM1944749",
"GSM1440659","GSM1922978","GSM1621378","GSM1853600","GSM2282042","GSM1853582","GSM1853567","GSM2308958","GSM1853558","GSM1558746","GSM1575574","GSM1853602","GSM1575572","GSM2059220","GSM1308260","GSM1853553","GSM1370360","GSM1853589","GSM1503907","GSM1853580","GSM2308962","GSM1575575","GSM1853596","GSM1853586","GSM2059227","GSM1552215","GSM1575580","GSM1551899","GSM1552217","GSM1503909",
"GSM1440660","GSM1853570","GSM1440662","GSM1503904","GSM2308963","GSM1853577","GSM2282041","GSM1853555","GSM2059224","GSM1440661","GSM1853572","GSM1370362","GSM1853561","GSM1853560","GSM1440658","GSM2059219","GSM2308960","GSM1853591","GSM2059225","GSM1853594","GSM2308956","GSM2059223","GSM1575578","GSM1552214","GSM1853593","GSM1503908","GSM1308259","GSM2059221","GSM2059218","GSM1853565",
"GSM2059217","GSM1621377","GSM1853603","GSM2282040","GSM2282038","GSM1440655","GSM1853563","GSM1440656","GSM1369388","GSM1369390","GSM1288865","GSM1288864","GSM1288870","GSM1288871","GSM1288877","GSM1551063","GSM1611599","GSM1690211","GSM1716870","GSM1969189","GSM2100594","GSM2152783","GSM2306238","GSM2309476","GSM2309455","GSM2295866","GSM2295873","GSM2165957","GSM2165956","GSM2165959",
"GSM2165958","GSM2041392","GSM2041393","GSM2041390","GSM2041391","GSM2041396","GSM2041394","GSM2041395","GSM2041398","GSM2295891","GSM2241325","GSM2241324","GSM2241326","GSM2241323","GSM2165968","GSM2165969","GSM2165960","GSM2165961","GSM2165962","GSM2165963","GSM2165964","GSM2165965","GSM2165966","GSM2165967","GSM2041389","GSM2165979","GSM2165978","GSM2165977","GSM2165976","GSM2165975",
"GSM2165974","GSM2165973","GSM2165972","GSM2165971","GSM2165970","GSM2165980","GSM2041405","GSM2041402","GSM2041403","GSM2295870","GSM2295871","GSM2295872","GSM2295874","GSM2295875","GSM2295876","GSM2295877","GSM2295878","GSM2295879","GSM2295892","GSM2295893","GSM2041406","GSM2041400","GSM2041401","GSM2041408","GSM2295884","GSM2295867","GSM2295881","GSM2295865","GSM2295864","GSM2295863",
"GSM2295862","GSM2295861","GSM2295869","GSM2295868","GSM2295889","GSM2295888","GSM2295880","GSM2295883","GSM2295882","GSM2295885","GSM2295887","GSM2295886","GSM2041407","GSM2041404","GSM2295890","GSM2041399","GSM2041397","GSM1269347","GSM1269349","GSM1269348","GSM1269344","GSM1269345","GSM1269346","GSM1709924","GSM1709923","GSM1709929","GSM1709928","GSM1709926","GSM1709927","GSM1709922",
"GSM1709925","GSM1964974","GSM1964976","GSM2131171","GSM2131172","GSM2440768","GSM2453193","GSM2475186","GSM2475184","GSM2475185","GSM2475190","GSM2475194","GSM2475189","GSM2475188","GSM2475187","GSM2475191","GSM2475193","GSM2475192","GSM2514486","GSM2514487","GSM2514489","GSM2514490","GSM2514488","GSM2514492","GSM2514494","GSM2514493","GSM2543168","GSM2543172","GSM2543171","GSM2543169",
"GSM2543174","GSM2543176","GSM2543167","GSM2543170","GSM2543173","GSM2543175","")

    # Retrieve information from compressed data
    samples = h5read(destination_file, "meta/Sample_geo_accession")
    tissue = h5read(destination_file, "meta/Sample_source_name_ch1")
    genes = h5read(destination_file, "meta/genes")

    # Identify columns to be extracted
    sample_locations = which(samples %in% samp)

    # extract gene expression from compressed data
    expression = h5read(destination_file, "data/expression", index=list(1:length(genes), sample_locations))
    H5close()
    rownames(expression) = genes
    colnames(expression) = samples[sample_locations]

    # Print file
    write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE)
    print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))
}
